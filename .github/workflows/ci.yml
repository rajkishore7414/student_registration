name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and start containers
        run: docker compose up --build -d

      - name: Wait for MySQL to be healthy
        run: |
          echo "Waiting for MySQL..."
          for i in $(seq 1 30); do
            if docker compose exec db mysqladmin ping -h localhost --silent 2>/dev/null; then
              echo "MySQL is ready!"
              break
            fi
            echo "Attempt $i/30 - waiting 2s..."
            sleep 2
          done

      - name: Verify app is running
        run: |
          echo "Checking if app responds..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "✅ App is running successfully!"
          else
            echo "❌ App returned status $HTTP_STATUS"
            docker compose logs app
            exit 1
          fi

      - name: Verify database table exists
        run: |
          TABLES=$(docker compose exec db mysql -u root student_db -e "SHOW TABLES;" 2>/dev/null)
          echo "$TABLES"
          if echo "$TABLES" | grep -q "students"; then
            echo "✅ Database table 'students' exists!"
          else
            echo "❌ Table 'students' not found!"
            exit 1
          fi

      - name: Print container logs (on failure)
        if: failure()
        run: docker compose logs

      - name: Tear down containers
        if: always()
        run: docker compose down -v

  # ──────────────────────────────────────────────────
  # OPTIONAL: Deploy to Docker Hub
  # ──────────────────────────────────────────────────
  # To enable this job:
  #   1. Go to your GitHub repo → Settings → Secrets → Actions
  #   2. Add DOCKER_USERNAME and DOCKER_PASSWORD secrets
  #   3. Uncomment the block below
  #
  # deploy:
  #   name: Deploy to Docker Hub
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Login to Docker Hub
  #       uses: docker/login-action@v3
  #       with:
  #         username: ${{ secrets.DOCKER_USERNAME }}
  #         password: ${{ secrets.DOCKER_PASSWORD }}
  #
  #     - name: Build and push Docker image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: .
  #         push: true
  #         tags: |
  #           ${{ secrets.DOCKER_USERNAME }}/student-registration:latest
  #           ${{ secrets.DOCKER_USERNAME }}/student-registration:${{ github.sha }}
